<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.ljq.bishe.mapper.ExchangeMapper">
    <select id="messageList" resultType="Message">
         select m.* from message m,course c where c.courseid=m.courseid and c.courseid in
         (select c.courseid from course c,selectcourse sc where sc.courseclass=c.courseclass and c.coursename=sc.coursename and c.teaid=sc.teaid  and sc.stuid=#{stuid});
    </select>
    <select id="replyList" resultType="Reply">
        select * from reply;
    </select>
    <select id="teaMessageList" resultType="Message">
        select m.* from message m left join course c on c.courseid=m.courseid where c.teaid =#{teaid};
    </select>
    <select id="teaReplyList" resultType="Reply">
        select * from reply;
    </select>
    <insert id="teaSendMessage" parameterType="String">
        insert into message (leaveid,leavename,messagebody,leavedate,messagetype,courseid,totalreply,praisenumber) VALUES
        (#{leaveid},#{leavename},#{messagebody},#{leavedate},#{messagetype},
        (SELECT courseid from course where coursename=#{course} and courseclass=#{courseClass} and teaid=#{leaveid}),0,0)
    </insert>
    <insert id="sendMessage" parameterType="String">
      insert into message (leaveid,leavename,messagebody,leavedate,messagetype,courseid,totalreply,praisenumber) VALUES
      (#{leaveid},#{leavename},#{messagebody},#{leavedate},#{messagetype},
      (select c.courseid from course c where c.coursename=#{course} and c.courseclass=#{courseClass}  and teaid in
      (select teaid from selectcourse sc where sc.coursename=#{course} and sc.courseclass=#{courseClass} and sc.stuid=#{stuid})),0,0)
    </insert>
    <insert id="teaReplyMessage" parameterType="String">
        insert into reply (messageid,replybody,replydate,replyname) VALUES
        (#{messageid},#{replybody},#{replydate},(select teaname from teacher where teaid = #{teaid}))
    </insert>
    <insert id="replyMessage" parameterType="String">
        insert into reply (messageid,replybody,replydate,replyname) VALUES
        (#{messageid},#{replybody},#{replydate},(select stuname from student where stuid = #{stuid}))
    </insert>
    <select id="teaFindMessage" parameterType="String" resultType="Message">
        SELECT m.* from message m left join course c on m.courseid = c.courseid
        <if test=" courseclass == 'all'">
            where c.teaid=#{teaid} and c.coursename=#{coursename};
        </if>
        <if test="courseclass != 'all'">
            where c.teaid=#{teaid} and c.coursename=#{coursename} and c.courseclass=#{courseclass};
        </if>
    </select>
    <select id="findMessage" parameterType="String" resultType="Message">
        select m.* from message m left join course c on m.courseid = c.courseid
        <if test=" courseclass == 'all'">
            where c.coursename=#{coursename} and c.teaid in
            (select teaid from selectcourse where stuid = #{stuid} and coursename=#{coursename});
        </if>
        <if test="courseclass != 'all'">
            where c.coursename=#{coursename} and c.courseclass=#{courseclass} and c.teaid in
            (select teaid from selectcourse where stuid = #{stuid} and coursename=#{coursename} and courseclass=#{courseclass});
        </if>
    </select>
    <select id="teaMyMessage" parameterType="String" resultType="Message">
        select * from message where leaveid = #{teaid}
    </select>
    <select id="myMessage" parameterType="String" resultType="Message">
        select * from message where leaveid = #{stuid}
    </select>
    <delete id="deleteMsg" parameterType="String">
        DELETE FROM message where messageid=#{messageid}
    </delete>
    <delete id="deleteReply" parameterType="String">
        DELETE FROM reply where messageid=#{messageid}
    </delete>
</mapper>