<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org" xmlns:v-on="http://www.w3.org/1999/xhtml">
<head>
    <script type="text/javascript" src="/js/jquery.min.js" th:src="@{/js/jquery.min.js}"></script>
    <script type="text/javascript" src="/js/bootstrap.min.js" th:src="@{/js/bootstrap.min.js}"></script>
    <script type="text/javascript" src="/js/highcharts.js" th:src="@{/js/highcharts.js}"></script>
    <link rel="stylesheet" href="/webapp/css/bootstrap.min.css" th:href="@{/css/bootstrap.min.css}">
    <meta charset="UTF-8">
    <title>Title</title>
    <style>
        .flex-container{
            position: relative;
            top: 19px;
            display: -webkit-flex;
            display: flex;
            -webkit-align-items: flex-start;
            align-items: flex-start;
        }
        .form-group {
            margin-left: 20px;
        }
        .noupload{
            top: 31px;
            position: relative;
            width: 90%;
            margin-left: 5%;
        }
        .charts{
            width: 90%;
            left: 4%;
        }
        .form{
            margin-left: 6%;
        }
        .chart{
            width: 48%;
        }
    </style>
</head>

<body>
<div class="">
    <div class="flex-container form">
        <div class="form-group flex-item">
            <label for="name">选择科目：</label>
            <select id="selectCourse" class="form-control">
                <option>请选择</option>
                <option th:each="wc:${course}" th:text="${wc}"></option>
            </select>
        </div>
        <div class="form-group flex-item">
            <label for="name">选择教学班：</label>
            <select id="selectCourseClass" class="form-control">
                <option>请选择</option>
            </select>

        </div>
        <div class="form-group flex-item" style="position: relative;top: 20px;">
            <button id="selectclass" type="button" class="btn btn-primary">确定</button>
        </div>
    </div>
    <div class="flex-container charts">
        <div class=" flex-item chart" id="container1"></div>
        <div class=" flex-item chart" id="container2"></div>
    </div>

    <div class="table-responsive noupload">
        <table class="table">
            <caption>未上交名单</caption>
            <thead>
            <tr>
                <th>姓名</th>
                <th>学号</th>
                <th>科目</th>
                <th>教学班</th>
                <th>第几次</th></tr>
            </thead>
            <tbody>
            </tbody>
        </table>
    </div>
</div>
<script language="JavaScript" type="text/javascript" th:inline="javascript">

    $(document).ready(function () {
        var allWorkData = [[${allWorkData}]];
        var courseList = [[${course}]];
        var handInData = [];
        var noHandInData = [];
        var noHandInCount = 0;
        var handInCount = 0;
        var stripSeriesAll = [];
        var sactorSeriesAll=[];
       for (var j = 0;j < courseList.length;j++){
            for (var i = 0;i<allWorkData.length;i++) {
                if (courseList[j] == allWorkData[i].coursename) {
                    if (allWorkData[i].state == "已上交") handInCount++ ;
                    else noHandInCount++;
                }
            }
            handInData.push(handInCount);
            noHandInData.push(noHandInCount);

           var num = new Number(handInCount/(handInCount + noHandInCount) * 100);
           sactorSeriesAll.push([courseList[j],parseFloat(num.toFixed(2))]);
           handInCount = 0;
           noHandInCount = 0;
        }
        stripSeriesAll.push({name: "已上交",data:handInData},{name: "未上交",data:noHandInData});
        drawStrip(courseList,stripSeriesAll);
        drawSactor(sactorSeriesAll);
    });

    $('#selectCourse').change(function () {
        $('#selectCourseClass').empty();
        var course = $(this).children('option:selected').val();
        var courseClass = [[${courseClass}]];
        $('#selectCourseClass').append('<option value="all">全部</option>');
        courseClass.forEach(myFunction);

        function myFunction(value, index, array) {
            if (course === value.coursename) {
                $('#selectCourseClass').append('<option value="' + value.courseclass + '">' + value.courseclass + '</option>');
            }
        }
    });

    $('#selectclass').click(function () {
        var course = $('#selectCourse').children('option:selected').val();
        var courseClass = $('#selectCourseClass').children('option:selected').val();
        var teaid = [[${teaid}]];
        $(".noupload table tbody").empty();
        $.ajax({
            url: '/teacher/selectclass',
            type: 'POST',
            data: {
                'course': course,
                'courseClass': courseClass,
                'teaid': teaid
            },
            dataType: 'json',
            success: function (data) {
                if (courseClass=="all"){
                    console.log(data);
                    var classList=[];
                    var temp;
                    for(var i =0;i < data.length;i++){
                            classList.push(data[i].courseclass);
                    }
                    classList = Array.from(new Set(classList))
                    let handInData = [];
                    let noHandInData = [];
                    let noHandInCount = 0;
                    let handInCount = 0;
                    let stripSeriesAll = [];
                    let sactorSeriesAll=[];
                    for (var j = 0;j < classList.length;j++){
                        for (var i = 0;i<data.length;i++) {
                            if (classList[j] == data[i].courseclass) {
                                if (data[i].state == "已上交") handInCount++ ;
                                else noHandInCount++;
                            }
                        }
                        handInData.push(handInCount);
                        noHandInData.push(noHandInCount);
                        var num = new Number(handInCount/(handInCount + noHandInCount) * 100);
                        sactorSeriesAll.push([classList[j],parseFloat(num.toFixed(2))]);
                        handInCount = 0;
                        noHandInCount = 0;
                    }
                    stripSeriesAll.push({name: "已上交",data:handInData},{name: "未上交",data:noHandInData});
                    drawStrip(classList,stripSeriesAll);
                    drawSactor(sactorSeriesAll);
                }else {
                    console.log(data);
                }

            }
        });
    });
    function drawStrip(courseList,stripSeriesAll) {
        var chart = {
            type: 'bar'
        };
        var title = {
            text: 'Historic World Population by Region'
        };
        var subtitle = {
            text: 'Source: Wikipedia.org'
        };
        var xAxis = {
            categories: courseList,
            title: {
                text: null
            }
        };
        var yAxis = {
            min: 0,
            title: {
                text: 'Population (millions)',
                align: 'high'
            },
            labels: {
                overflow: 'justify'
            }
        };
        var tooltip = {
            valueSuffix: ' millions'
        };
        var plotOptions = {
            bar: {
                dataLabels: {
                    enabled: true
                }
            }
        };
        var legend = {
            layout: 'vertical',
            align: 'right',
            verticalAlign: 'top',
            x: -40,
            y: 100,
            floating: true,
            borderWidth: 1,
            backgroundColor: ((Highcharts.theme && Highcharts.theme.legendBackgroundColor) || '#FFFFFF'),
            shadow: true
        };
        var credits = {
            enabled: false
        };

        var series= stripSeriesAll;

        var json = {};
        json.chart = chart;
        json.title = title;
        json.subtitle = subtitle;
        json.tooltip = tooltip;
        json.xAxis = xAxis;
        json.yAxis = yAxis;
        json.series = series;
        json.plotOptions = plotOptions;
        json.legend = legend;
        json.credits = credits;
        $('#container1').highcharts(json);
    }
    function drawSactor(sactorSeriesAll){
        var chart = {
            plotBackgroundColor: null,
            plotBorderWidth: null,
            plotShadow: false
        };
        var title = {
            text: '2014 年各浏览器市场占有比例'
        };
        var tooltip = {
            pointFormat: '{series.name}: <b>{point.percentage:.1f}%</b>'
        };
        var plotOptions = {
            pie: {
                allowPointSelect: true,
                cursor: 'pointer',
                dataLabels: {
                    enabled: true,
                    format: '<b>{point.name}%</b>: {point.percentage:.1f} %',
                    style: {
                        color: (Highcharts.theme && Highcharts.theme.contrastTextColor) || 'black'
                    }
                }
            }
        };
        var series= [{
            type: 'pie',
            name: 'Browser share',
            data: sactorSeriesAll
        }];

        var json = {};
        json.chart = chart;
        json.title = title;
        json.tooltip = tooltip;
        json.series = series;
        json.plotOptions = plotOptions;
        $('#container2').highcharts(json);
    }
</script>
<script language="JavaScript">
</script>
</body>
</html>